## AOP 소개 - 핵심 기능과 부가 기능

### 핵심 기능과 부가 기능

- 애플리케이션 로직은 크게 **핵심 기능**과 **부가 기능**으로 나눠짐
- 핵심 기능 : 해당 객체가 제공하는 고유의 기능
- 부가 기능 : 핵심 기능을 보조하기 위해 제공되는 기능 `ex) 로그 추적, 트랜잭션`

보통 부가 기능은 여러 클래스에 걸쳐서 함께 사용됨. 예를 들어서 모든 애플리케이션 호출을 로깅 ← 이러한 부가 기능은 **횡단 관심사(cross-cutting concerns)**가 됨

### 부가 기능 적용 문제

- 부가 기능을 적용할 때 아주 많은 반복이 필요함
- 부가 기능이 여러 곳에 퍼져서 중복 코드를 만들어냄
- 부가 기능 변경 시 많은 수정이 필요함
- 부가 기능 적용 대상을 변경할 때 많은 수정이 필요함

## AOP 소개 - Aspect

### 핵심 기능과 부가 기능을 분리

`Aspect` : 부가 기능과 부가 기능을 어디에 적용할지 선택하는 기능을 합해서 하나의 모듈로 만듬

- 스프링이 제공하는 어드바이저도 어드바이스, 포인트컷을 가지고 있어서 개념상 하나의 애스펙트이다.
- 해석하면 관점이라는 뜻 → 하나하나의 기능에서 횡단 관심사(cross-cutting concerns) 관점으로 달리 보는 것

**이렇게 애스펙트를 사용한 프로그래밍 방식을 관점 지향 프로그래밍 AOP(Aspect-Oriented Programming)이라함**

**AspectJ 프레임워크**

AOP의 대표적인 구현으로 AspectJ 프레임워크가 있음. 물론 스프링도 AOP를 지원하지만 대부분 AspectJ의 문법을 차용하고, AspectJ가 제공하는 기능의 일부만 제공

- 자바 프로그래밍 언어에 대한 완벽한 관점 지향 확장
- 횡단 관심사의 깔끔한 모듈화
  - 오류 검사 및 처리
  - 동기화
  - 성능 최적화(캐싱)
  - 모니터링 및 로깅

## AOP 적용 방식

크게 3가지 방법이 있음

- 컴파일 시점
  - .class 파일에 애스펙트 관련 호출 코드가 들어감
  - AspectJ 컴파일러가 Aspect를 확인해서 해당 클래스가 적용 대상인지 먼저 확인하고, 적용 대상인 경우에 부가 기능 로깆ㄱ을 적용한다
  - 원본 로직에 부가 기능 로직이 추가되는 것을 `위빙(Weaving)` 이라고 함
  - 단점 : 컴파일 시점에 부가 기능을 적용하려면 특별한 컴파일러도 필요하고 복잡함
- 클래스 로딩 시점
  - 자바 실행시 .class를 JVM 내부의 클래스 로더에 보관함
  - 중간에 .class 파일을 조작한 다음 JVM에 올릴 수 잇음
  - 수 많은 모니터링 툴들이 이 방식을 사용
  - `로드 타임 위빙`이라고 함
- 런타임 시점(프록시)
  - 컴파일도 끝나고 클래스 로더에 클래스도 다 올라가서 이미 자바가 실행되고 난 다음을 말함
  - 스프링과 같은 컨테이너의 도움을 받고 프록시와 DI, 빈 포스트 프로세서와 같은 개념들을 총 동원해야 함. 이렇게 하면 최종적으로 프록시를 통해 스프링 빈에 부가 기능을 적용할 수 있다.
  - 프록시 방식을 사용하는 스프링 AOP는 메서드 실행 지점에만 AOP를 적용할 수 잇음
    - 프록시는 메서드 오버라이딩 개념으로 동작. 따라서 생성자나 static 메서드, 필드 값 점근에는 프록시 개념이 적용될 수 없음
    - 프록시를 사용하는 **스프링 AOP의 조인 포인트는 메서드 실행으로 제한**
    - 스프링 AOP는 스프링 빈에만 AOP를 적용할 수 있음

## AOP 용어 정리

- `조인 포인트(Join point)`
  - 어드바이스가 적용될 수 잇는 위치, 메서드 실행, 생성자 호출, 필드 값 접근, static 메서드 접근 같은 프로그램 실행 중 지점
  - **AOP를 적용할 수 잇는 모든 지점**
  - 스프링 AOP는 프록시 방식을 사용하므로 조인 포인트는 항상 메서드 실행 지점임
- `포인트컷(Pointcut)`
  - 조인 포인트 중에서 어드바이스가 적용될 위치를 선별하는 기능
  - 주로 AspectJ 표현식을 사용해서 지정
  - 프록시를 사용하는 스프링 AOP는 메서드 실행 지점만 포인트컷으로 선별 가능
- `타겟(Target)`
  - 어드바이스를 받는 객체, 포인트컷으로 결정
- `어드바이스(Advice)`
  - 부가 기능
  - 특정 조인 포인트에서 Aspect에 의해 취해지는 조치
  - Arround(주변), Before(전), After(후)와 같은 다양한 종류의 어드바이스가 있음
- `애스펙트(Aspect)`
  - 어드바이스 + 포인트컷을 모듈화 한 것
  - 여러 어드바이스와 포인트 컷이 함께 존재
- `어드바이저(Advisor)`
  - 하나의 어드바이스와 하나의 포인트 컷으로 구성
  - 스프링 AOP에서만 사용되는 특별한 용어
- `위빙(Weaving)`
  - 포인트컷으로 결정한 타겟의 조인 포인트에 어드바이스를 적용하는 것
  - 위빙을 통해 핵심 기능 코드에 영향을 주지 않고 부가 기능을 추가할 수 잇음
  - AOP 적용을 위해 에스펙트를 객체에 연결한 상태
    - 컴파일 타임
    - 로드 타임
    - 런타임
- `AOP 프록시`
  - AOP 기능을 구현하기 위해 만든 프록시 객체, 스프링에서 AOP 프록시는 `JDK 동적 프록시` 혹은 `CGLIB 프록시`이다.
