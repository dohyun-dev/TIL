데이터베이스에서 동시성 이슈가 발생하는 일반적인 패턴

- 공유자원 조회
- 공유자원 생신

## 쓰기락, 읽기락

락을 통해 동시성을 제어할 때는, 락의 범위를 최소화 하는 것이 중요

→ 트랜잭션이 곧 락의 범위

|                        | 읽기락(Shared Lock) | 쓰기락(Exclusive Lock) |
| ---------------------- | ------------------- | ---------------------- |
| 읽기락(Shared Lock)    | O                   | 대기                   |
| 쓰기락(Exclusive Lock) | 대기                | 대기                   |

읽기락 : SELECT ~ FOR SHARE

쓰기락 : SELECT ~ FOR UPDATE

MySQL에서 잠금은 row가 아니라 인덱스를 잠금

→ 인덱스가 없는 조건으로 Locking Read시 불필요한 데이터들이 잠길 수 있음

```sql
# 트랜잭션 정보
select * from information_schema.INNODB_TRX;

# 락 정보
select * from performance_schema.data_locks;
```

## 좋아요 기능 구현

## 낙관적 락

동시성 제어를 위한 가장 보편적인 방법은 락을 통한 줄세우기 → 비관적 락

낙관적락 → CAS를 통한 제어 → 트랜잭션 ID를 통한 제어

### 읽기와 쓰기의 트레이드 오프

1. 게시물에 컬럼 추가를 통한 구현 - 비관적 락
2. 게시물에 컬럼 추가를 통한 구현 - 낙관적 락
   - 조회시 컬럼만 읽어오면 됨
   - 쓰기시 게시물 레코드에 대한 경합이 발생
     → 하나의 자원을 두고 락 대기
   - 같은 회원이 하나에 게시물에 대해 여러번 좋아요를 누를 수 있음
3. 좋아요 테이블 추가를 통한 구현
   - 조회시 매번 count 쿼리 연산
   - 쓰기시 경합없이 인서트만 발생
   - 회원정보등 다양한 정보 저장 가능

쓰기 지점 병목은 하나의 레코드를 점유

조회 지점의 병목은 카운트 쿼리

좋아요 수는 높은 정합성을 요구하는 데이터인가?
